Ссылка на бот: https://t.me/sd_courses_feedback_bot


По дефолту доступны только команды студента, чтобы стать админом напишите @nikitayusupov


---

## Цель

Разработать Telegram-бота для автоматизации сбора обратной связи от студентов, обучающихся на курсе. Бот должен отправлять опросы участникам из заданных куратором списков, собирать ответы и сохранять их в БД (позже добавим Google Таблицы).

## Основные функции

#### **Отправка опросов**

* Бот рассылает опросы по запросу от куратора (/send\_now) выбранной группе студентов.  
* Опрос отправляется в **личные сообщения** каждому участнику из заранее сохраненного списка.  
* Опрос состоит из **до 7 вопросов**, включающих:  
  * Вопросы с ответом по шкале от 1 до 10\.  
  * Вопросы со **свободной формой ответа**.  
* Вопросы отправляются **по одному** — следующий приходит **только после ответа на предыдущий**.  
* Студент может **пропустить вопрос** командой /skip.

#### **Работа с группами**

* Куратор может создавать и настраивать **несколько групп студентов**:  
  * Команда /set\_group — создание новой группы.  
  * Команда /set\_recipients — добавление или обновление участников группы (по @username).  
  * Команда /list\_recipients — просмотр списка студентов в группе.
  * Команда /add\_recipient — добавление отдельного студента в группу.
  * Команда /delete\_recipient — удаление студента из группы.

#### **Работа с опросами**

* Куратор может создавать и настраивать **опросы** для групп:
  * Команда /create\_survey — создание нового опроса для группы с заданным названием.
  * Команда /list\_surveys — просмотр списка всех опросов группы.
  * Команда /set\_questions — добавление вопросов к конкретному опросу.
  * Команда /list\_questions — просмотр списка вопросов конкретного опроса.
  * Каждый опрос имеет набор вопросов, которые задаются студентам.

#### **Ответы и фидбек**

* Команда /feedback доступна студентам в любой момент:  
  * Выбор курса для отзыва.
  * Выбор анонимности: отправить отзыв анонимно или с указанием имени.
  * Ввод темы вопроса.  
  * Ввод текста фидбека в свободной форме.  
* Фидбек сохраняется в Google Таблице и отправляется куратору.

#### **Старт и справка**

* /start — приветственное сообщение, описание целей бота.  
* /help — список доступных команд и их назначение.

## Хранение данных

#### **Список студентов**

* Хранится внутри бота отдельно для каждой группы.  
* Поддерживается редактирование, добавление и удаление.

#### **Список опросов и вопросов**

* Опросы привязаны к группам (группа может иметь несколько опросов).
* Вопросы привязаны к конкретным опросам (не к группам).
* Поддерживается создание, редактирование и удаление.

## Технические детали

### Правила нейминга для username в коде: 
- Ввод куратора требует @.
- Хранение и поиск в БД — всегда без @.
- Проверка прав куратора — удаляет @ перед поиском.
- Фидбек студента — сохраняется без @.

### Роли
- Студент
    - Имеет доступ к команде feedback, а также может отвечать на присылаемые опросы
- Куратор
    - Привязан к определенному курсу (или нескольким курсам)
    - Имеет доступ к командам управлениям группами: может создавать и удалять группы в рамках доступных курсов
    - Может добавлять и удалять студентов из групп в рамках своего курса
- Админ
    - Не привязан к курсу или группе
    - Может управлять курсами: создать новые и удалять существующие курсы (при этом удаляются все связанные с курсом группы)
    - Может управлять кураторами: добавлять новых кураторов или удалять существующих, назначить их на определенные группы 
    


## Функциональность для куратора

* **/set\_group**  — создать группу слушателей   
  - Для создания группы нужно выбрать курс, к котором будет привязана группа. Группа может быть привязана только к одному курсу. 
  - В рамках одного курса не должно быть двух групп с одинаковым названием. При этом группы из разных курсов могут называться одинаково. 
* **/list\_groups** — показать список групп для выбранного курса
* **/set\_recipients** — Добавление или обновление списка студентов внутри группы  
  - Куратор вводит список юзеров, из которых будет состоять группа
  - Если в группе уже состояли какие-то студенты, которых нет в новом списке, то такие студенты удаляются из группы. 
  - Студент может состоять только в одной группе в рамках заданного, поэтому при попытке добавить студента во вторую группу будет выдана ошибка. 
    - При этом студент может состоять в разных группах, если эти группы относятся к разным курсам. 
* **/list\_recipients** — просмотр списка студентов в выбранной группе.
* **/add\_recipient** — добавление отдельного студента в выбранную группу.
* **/delete\_recipient** — удаление студента из выбранной группы.
* **/create\_survey** — создание нового опроса с заданным названием для группы.
* **/list\_surveys** — просмотр списка опросов для выбранной группы.
  - Отображает все созданные опросы для группы с подробной информацией:
    - Название опроса и дата создания
    - Количество вопросов в опросе
    - Количество студентов, ответивших на опрос
  - Позволяет быстро видеть активность и прогресс по каждому опросу
* **/list\_questions** — просмотр списка вопросов для выбранного опроса.
  - Отображает все вопросы конкретного опроса с их типами:
    - Порядковый номер и текст вопроса
    - Тип вопроса: "Шкала 1-10" или "Текстовый ответ"
  - Позволяет быстро проверить содержание опроса перед отправкой студентам
* **/set\_questions** — добавить или изменить список вопросов для конкретного опроса.
  - Вопросы привязываются к опросу, а не к группе напрямую.
  - Если для данного опроса уже созданы какие-то вопросы, то сначала куратору предлагается удалить все вопросы, а затем создать новые.
* **/send\_now** — вручную запустить определенный опрос для выбранной группы студентов. В рамках одной группы может быть несколько опросов.

## Функциональность для админа 
- create_course
  - Добавляется новый курс
- add_curator
  - Прикрепить нового куратора к курсу
- delete_course
  - Удаляется выбранный курс. 
  - Вместе с курсом удаляются и все группы внутри данного курса. 
    - Из каждой группы также отчисляются все студенты, которые были привязаны к этой группе

## Обновление модели данных: Вопросы и опросы

В последнем обновлении изменена структура связи между вопросами и опросами:

- **Раньше**: Вопросы привязывались напрямую к группам.
- **Теперь**: Вопросы привязываются к опросам (Survey), которые в свою очередь привязаны к группам.

Это позволяет:
1. Создавать несколько различных опросов для одной группы
2. Использовать именованные опросы для лучшей организации обратной связи
3. Сохранять историю предыдущих опросов

### Миграция данных

При обновлении системы запустите скрипт миграции для преобразования существующих данных:

```bash
python run_question_migration.py
```

Миграция:
- Создаст для каждой группы с вопросами соответствующий опрос
- Перенесет существующие вопросы в новую структуру
- Сохранит все данные без потерь

## Настройка интеграции с Google Sheets

Бот имеет возможность сохранять отзывы студентов в Google Sheets, что позволяет удобно анализировать и обрабатывать обратную связь. Для настройки интеграции необходимо:

1. **Создать проект в Google Cloud Platform (GCP)**:
   - Зарегистрируйтесь или войдите в [Google Cloud Console](https://console.cloud.google.com/)
   - Создайте новый проект
   - Включите Google Sheets API в разделе "APIs & Services" > "Library"
   - Создайте учетные данные сервисного аккаунта через "APIs & Services" > "Credentials"
   - Скачайте JSON-файл с ключом сервисного аккаунта

2. **Настройте Google Sheets**:
   - Создайте новую таблицу Google Sheets или используйте существующую
   - Скопируйте ID таблицы из URL (например, из https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit)
   - Предоставьте доступ к таблице для email-адреса сервисного аккаунта (он указан в JSON-файле) с правами редактирования

3. **Настройте переменные окружения**:
   - Отредактируйте файл `.env` и добавьте следующие переменные:
     ```
     GSHEET_ID=ваш_id_таблицы
     GOOGLE_CREDENTIALS_PATH=путь_к_файлу_учетных_данных.json
     GSHEET_URL=полный_url_таблицы
     GSHEET_TAB_NAME=название_вкладки (по умолчанию "feedback")
     ```

После этих настроек каждый отзыв, отправленный через команду `/feedback`, будет автоматически сохраняться в Google Sheets с указанием времени, имени пользователя, названия курса, темы и текста отзыва.
